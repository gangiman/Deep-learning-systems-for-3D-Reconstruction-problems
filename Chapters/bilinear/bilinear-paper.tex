


\chapter{Multi-region Bilinear Convolutional Neural Networks for Person Re-Identification}

\label{chapt:bilinear}

\section{Motivation}
%: relation to fine-grained recognition and Bilinear CNNs
%TODO relocate images (false positive-left, )
\begin{figure*}[t]%{R}{0.5\textwidth}
\centering

\begin{tabular}{c c}

    False positives & False negatives \\
    \begin{tabular}{c c }
    % \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_pos1.png}&
    % \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_pos2.png}\\
    % \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_pos3.png}&
    % \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_pos4.png}
    
    
    \end{tabular} &
    
    
    \begin{tabular}{c c }

    \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_neg1.png}&
    \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_neg2.png}\\
    \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_neg3.png}&
    \includegraphics[ height=3.5cm, width=2.5cm]{\bilinearroot/figures/pedestrians_pairs/false_neg4.png}
    
    
    \end{tabular}
    \\

    
    \begin{tabular}{c }
    \includegraphics[ height=3cm, width=5.5cm]{\bilinearroot/figures/birds/birds_false_pos1.png}\\
    \includegraphics[ height=3cm, width=5.2cm]{\bilinearroot/figures/birds/birds_false_pos2.png}
    
    \end{tabular} &
    \begin{tabular}{c }

    \includegraphics[ height=3cm, width=5.5cm]{\bilinearroot/figures/birds/birds_false_neg1.png}\\
    \includegraphics[ height=3cm, width=5.5cm]{\bilinearroot/figures/birds/birds_false_neg2.png}
    
    \end{tabular} 
    \\
    (a) & (b)


\end{tabular} 
\caption{Difficult re-identification cases in the CUHK03 dataset and the CUB-Birds dataset for the fine-grained classification~\citep{Wah11}. (a) -- the pairs of very similar images depicting different persons/bids species (b) -- the pairs of dissimilar images depicting the same person/bird species. There is a clear similarity between the challenges posed by the two tasks. Both re-identification and fine-grained classification deal with strong viewpoint variations, and often need to focus on small-scale fragments in order to distinguish subjects/classes. At the same time the re-identification task has a greater degree of alignment, and we therefore suggest a modification of the bilinear CNN exploiting the presenсe of such weak alignment in the re-identification case.}
\label{fig:teaser}
\end{figure*}

\textit{Fine-grained recognition tasks} are usually characterized by small visual differences between the categories and possibly large intra-category differences. The examples of the former are different bird species of similar color and pedestrians wearing similar clothes, the latter is often due to high variations caused by such factors as pose and lighting. 

The task of person re-identification shares considerable similarity with fine-grained categorization (see the example pairs in \fig{teaser}), as the matching process in both cases often needs to resort to the analysis of fine texture details and parts that are hard to localize. 

\textit{Bilinear convolutional neural networks} have been first suggested by \citep{lin2015bilinear} for fine-grained categorization tasks. The idea of this architecture is to utilize multiplicative interactions between different features computed using two feature extractor subnetworks. The intuition behind this suggests that such factorization may allow the model to learn such functions as detection (some parts may be detected, \eg{} birds beaks, heads) and recognition (\eg{} colors and textures). When the features carrying information about parts are combined in a  multiplicative way with the features carrying some texture information, the result may capture more complex concepts, \eg{} particular parts of particular color/texture.

The bilinear layer suggested by \citep{lin2015bilinear} is defined as follows:

\begin{equation}
   \label{eq:bilinear}
    x_{bilinear} = A^T B,
\end{equation}
where $A$ and $B$ are the outputs of the two deep feature extractors $f_A$ and $f_B$ (convolutional neural networks). $A \in \mathbb{R}^{S \times M}$, $B \in \mathbb{R}^{S \times N}$, $S$ is the number of spatial locations, $M$ and $N$ are the number of the featuremaps that the extractors $f_A$ and $f_B$ produce. The result of this operation is a matrix of size $M \times N$, but is reshaped to a vector $MN \times 1$.

Another characteristic that differs Bilinear CNNs from regular models is related to the way of handling the image spatial information. Non-bilinear architectures (\eg{} \citep{simonyan2014very}) apply fully-connected layers to the output of the last convolution layer to compute the final representation. In this case, each output element is computed by applying different weights to the input elements. It is easy to see that such operation may preserve some spatial information by assigning bigger weights for particular regions of the input feature maps. 

Bilinear CNNs, however, rather radically discard spatial information in the process of the sum-pooling. For very deep and powerful architectures like \citep{simonyan2014very}, such spatial information may be rather irrelevant and therefore can be easily discarded. In contrast, for more shallow architectures, like those that have been recently most popular for person re-identification, the radical pooling over all spatial locations may lead to a noticeable performance drop.

Moreover, as evidenced by the experiments of \citep{lin2015bilinear}, Bilinear CNNs with global pooling and powerful feature extractors are very appropriate for the tasks where pose variability may be very high, \eg{} bird species recognition  (for example of very different poses, see the lower picture in \fig{teaser}b). At the same time, the variability of geometric pose and viewpoints in re-identification problems is more restricted.

Thus the CNN architecture for person re-identification should be developed in the light of the discussed circumstances of this task, namely:
\begin{itemize}
    \item moderate-size architectures being used for person re-identification,
    \item more restricted pose variation of pedestrians, compared to other fine-grained recognition problems.
\end{itemize}
   
Given these preliminaries, it is appropriate to consider some intermediate variant that would preserve the features of both Bilinear and standard architectures. Indeed, such a variant, called Multi-region Bilinear CNN, is discussed later in this chapter. It can be regarded as a middle ground between the traditional CNNs and the Bilinear CNNs. In the experiments presented in this chapter, it is also shown that such a compromise achieves an optimal performance across a range of person re-identification benchmarks, while also performing favorably compared to the  previous state-of-the-art. The success of such architecture confirms the promise hold by deep architectures with multiplicative interactions such as Bilinear CNNs and the Multi-region Bilinear CNNs for hard pattern recognition tasks.

It should also be mentioned, that the Bilinear CNN with global pooling has been successfully applied to person re-identification by \citep{suh2018part} (after this work). The authors used powerful models of \citep{szegedy2015going} and \citep{cao2017realtime} (pre-trained for human pose estimation) for the recognition and detection streams correspondingly. This work presents some earlier (and lower) results, for which no explicit body part detection has been used. However, this work is the earliest to consider person re-identification a fine-grained problem and to adopt the Bilinear architecture for it. %discuss the results without pose estimation to our results?


%%%%%%%%% ABSTRACT
% \subsection{abstract}
% In this work we propose a new architecture for person re-identification. As the task of re-identification is inherently associated with embedding learning and non-rigid appearance description, our architecture is based on the deep bilinear convolutional network (Bilinear-CNN) that has been proposed recently for fine-grained classification of highly non-rigid objects. While the last stages of the original Bilinear-CNN architecture completely removes the geometric information from consideration by performing orderless pooling, we observe that a better embedding can be learned by performing bilinear pooling in a more local way, where each pooling is confined to a predefined region. Our architecture thus represents a compromise between traditional convolutional networks and bilinear CNNs and strikes a balance between rigid matching and completely ignoring spatial information.

% We perform the experimental validation of the new architecture on the three popular benchmark datasets (Market-1501, CUHK01, CUHK03), comparing it to baselines that include Bilinear-CNN as well as prior art. The new architecture outperforms the baseline on all three datasets, while performing better than state-of-the-art on two out of three. The code and the pretrained models of the approach can be found at \url{https://github.com/madkn/MultiregionBilinearCNN-ReId}.



%\input{\bilinearroot/intro}


% \begin{figure*}[t]%{R}{0.5\textwidth}
% \centering

% \begin{tabular}{c c}

% \begin{tabular}{c c c c}

% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_pos1.png}&
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_pos2.png}&
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_pos3.png}&
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_pos4.png}
% \\
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_neg1.png}&
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_neg2.png}&
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_neg3.png}&
% \includegraphics[ height=2cm, width=1.2cm]{\bilinearroot/figures/pedestrians_pairs/false_neg4.png}
% \end{tabular} &
% \begin{tabular}{c c}
% \includegraphics[ height=2cm, width=4cm]{\bilinearroot/figures/birds/birds_false_pos1.png}&
% \includegraphics[ height=2cm, width=4cm]{\bilinearroot/figures/birds/birds_false_pos2.png}


% \\
% \includegraphics[ height=2cm, width=4cm]{\bilinearroot/figures/birds/birds_false_neg1.png}&
% \includegraphics[ height=2cm, width=4cm]{\bilinearroot/figures/birds/birds_false_neg3.png}

% \end{tabular}
% \end{tabular} 
% \caption{Left-- difficult re-identification cases in the CUHK03 dataset \citep{li2014deepreid}. The pairs in the upper row show very similar images depicting different persons, the pairs in the lower row show dissimilar images depicting the same person. Right -- analogous cases for the CUB-Birds dataset for the fine-grained classification~\citep{Wah11}. There is a clear similarity between the challenges posed by the two tasks. Both re-identification and fine-grained classification deal with strong viewpoint variations, and often need to focus on small-scale fragments in order to distinguish subjects/classes. At the same time the re-identification task has a greater degree of alignment, and we therefore suggest a modification of the bilinear CNN exploiting the presenсe of such weak alignment in the re-identification case.}
% \label{fig:teaser}
% \end{figure*}


\begin{figure*}
\begin{center}
    

\begin{tabular}{c}
 
    
            \includegraphics[width=0.7\textwidth]{\bilinearroot/figures/architecture/multiregion_bilinear.eps}\\
    (a)\\
            \includegraphics[width=0.7\textwidth]{\bilinearroot/figures/architecture/architecture.pdf}
            \\
    (b)\\
   
 \end{tabular}
        \caption{The proposed architecture for person re-identification: (a) - multi-region bilinear sub-network used for each of the three parts of the input image, (b) - the whole multi-region Bilinear CNN architecture that uses bilinear pooling over regions rather than the entire image. The new architecture achieves state-of-the-art performance over a range of benchmark datasets.}
        \label{fig:architecture}
    \end{center}
\end{figure*}

%\input{\bilinearroot/related}
\input{\bilinearroot/method}
\input{\bilinearroot/experiments}

\begin{figure}
\includegraphics[height=0.76\textheight]{\bilinearroot/figures/market_random.png}
\caption{The result of the proposed architecture on the Market-1501 dataset for a random subset of queries. The queries are shown on the left, and the remaining images in each row show the closest matches in the gallery dataset.}
\label{fig:market_retrieval}
\end{figure}

\input{\bilinearroot/conclusion}

